## 상수 함수 마켓 메이커 (Constant Function Market Makers)

> 이 장에서는 [Uniswap V2 백서](https://uniswap.org/whitepaper.pdf)의 내용을 다시 설명합니다. 이 수학적 내용을 이해하는 것은 Uniswap과 유사한 탈중앙화 거래소(DEX)를 구축하는 데 매우 중요하지만, 현 단계에서 모든 것을 완벽하게 이해하지 못해도 괜찮습니다.

앞선 섹션에서 언급했듯이, 자동화된 마켓 메이커(AMM)를 구축하는 데에는 다양한 접근 방식이 있습니다. 여기서는 특정 유형의 AMM인 상수 함수 마켓 메이커에 집중하여 구축하는 과정을 살펴보겠습니다. 긴 이름에 겁먹지 마세요! 핵심은 매우 간단한 수학 공식에 있습니다:

$$x * y = k$$

이것이 바로 AMM의 전부입니다.

$x$와 $y$는 풀 컨트랙트 준비금, 즉 현재 보유하고 있는 토큰의 양입니다. $k$는 단순히 이들의 곱이며, 실제 값은 중요하지 않습니다.

> **왜 준비금이 $x$와 $y$ 두 개뿐인가요?**
> 각 Uniswap 풀은 두 종류의 토큰만 보유할 수 있습니다. $x$와 $y$는 하나의 풀의 준비금을 나타내기 위해 사용되며, $x$는 첫 번째 토큰의 준비금, $y$는 다른 토큰의 준비금을 의미하며, 순서는 중요하지 않습니다.

상수 함수 공식은 **각 거래 후에도 $k$는 변하지 않아야 한다**고 말합니다. 트레이더가 거래를 할 때, 그들은 일정량의 한 토큰을 풀에 넣고 (판매하려는 토큰) 다른 토큰의 일정량을 풀에서 꺼냅니다 (구매하려는 토큰). 이는 풀의 준비금을 변경시키며, 상수 함수 공식은 준비금의 **곱**은 변하지 않아야 한다고 명시합니다. 이 책에서 여러 번 보게 되겠지만, 이 간단한 요구 사항이 Uniswap 작동 방식의 핵심 알고리즘입니다.

## 거래 함수 (The Trade Function)
이제 풀이 무엇인지 알았으니, 풀에서 거래가 어떻게 이루어지는지 공식을 작성해 보겠습니다:

$$(x + r\Delta x)(y - \Delta y) = k$$

1. 토큰 0 ($x$)의 일정량과 토큰 1 ($y$)의 일정량을 가진 풀이 있습니다.
2. 토큰 0으로 토큰 1을 구매할 때, 우리는 일정량의 토큰 0을 풀에 제공합니다 ($\Delta x$).
3. 풀은 그 대가로 일정량의 토큰 1을 우리에게 제공합니다 ($\Delta y$).
4. 풀은 또한 우리가 제공한 토큰 0의 양에서 작은 수수료 ($r = 1 - \text{스왑 수수료}$)를 취합니다.
5. 토큰 0의 준비금은 ($x + r \Delta x$)로 변경되고, 토큰 1의 준비금도 ($y - \Delta y$)로 변경됩니다.
6. 업데이트된 준비금의 곱은 여전히 $k$와 같아야 합니다.

> 코드에서 토큰을 참조하는 방식 때문에 토큰 0과 토큰 1 표기법을 사용합니다. 이 시점에서 어느 것이 0이고 어느 것이 1인지는 중요하지 않습니다.

기본적으로 우리는 풀에 일정량의 토큰 0을 제공하고 일정량의 토큰 1을 얻습니다. 풀의 역할은 공정한 가격으로 계산된 정확한 양의 토큰 1을 우리에게 제공하는 것입니다. 이는 다음과 같은 결론으로 이어집니다. **풀이 거래 가격을 결정합니다.**

## 가격 결정 (Pricing)

풀에서 토큰의 가격은 어떻게 계산할까요?

Uniswap 풀은 독립적인 스마트 컨트랙트이기 때문에, **풀 내의 토큰 가격은 서로를 기준으로 책정됩니다**. 예를 들어: ETH/USDC 풀에서 ETH 가격은 USDC 기준으로, USDC 가격은 ETH 기준으로 책정됩니다. 만약 1 ETH가 1000 USDC라면, 1 USDC는 0.001 ETH입니다. 이는 스테이블 코인 쌍이든 아니든 (예: ETH/BTC) 다른 모든 풀에도 동일하게 적용됩니다.

실제 세계에서는 모든 것이 [수요와 공급의 법칙](https://www.investopedia.com/terms/l/law-of-supply-demand.asp)에 따라 가격이 결정됩니다. 이는 AMM에도 마찬가지로 적용됩니다. 수요 부분은 잠시 제쳐두고 공급에 집중해 보겠습니다.

풀에서 토큰의 가격은 토큰의 공급량, 즉 **풀이 보유하고 있는 토큰 준비금의 양**에 의해 결정됩니다. 토큰 가격은 단순히 준비금의 비율입니다:

$$P_x = \frac{y}{x}, \quad P_y=\frac{x}{y}$$

여기서 $P_x$와 $P_y$는 다른 토큰으로 표시되는 토큰의 가격입니다.

이러한 가격을 *현물 가격*이라고 하며, 현재 시장 가격만 반영합니다. 그러나 실제 거래 가격은 다르게 계산됩니다. 그리고 여기서 수요 부분을 다시 가져와야 합니다.

수요와 공급의 법칙에서 결론을 내리면, **높은 수요는 가격을 상승시킵니다.** 이는 허가 없는 시스템에서 반드시 가져야 할 속성입니다. 우리는 수요가 높을 때 가격이 높고, 풀 준비금을 사용하여 수요를 측정할 수 있기를 원합니다. 풀에서 제거하려는 토큰이 많을수록 (풀의 준비금에 상대적으로), 수요의 영향이 더 커집니다.

거래 공식으로 돌아가서 자세히 살펴보겠습니다:

$$(x + r\Delta x)(y - \Delta y) = xy$$

보시다시피, 여기서 $\Delta_x$와 $\Delta y$를 유도할 수 있습니다. 즉, 입력 금액을 기준으로 출력 금액을 계산하거나 그 반대로도 계산할 수 있습니다:

$$\Delta y = \frac{yr\Delta x}{x + r\Delta x}$$
$$\Delta x = \frac{x \Delta y}{r(y - \Delta y)}$$

사실, 이 공식들은 가격 계산으로부터 우리를 자유롭게 해줍니다! 우리는 항상 $\Delta y$ 공식을 사용하여 출력 금액을 찾을 수 있고 (알려진 양의 토큰을 판매하려는 경우), 항상 $\Delta x$ 공식을 사용하여 입력 금액을 찾을 수 있습니다 (알려진 양의 토큰을 구매하려는 경우). 각 공식은 준비금의 비율 ($x/y$ 또는 $y/x$)이며 거래 금액 ($\Delta x$는 전자의 경우, $\Delta y$는 후자의 경우)도 고려한다는 점에 유의하세요. **이것들은 수요와 공급을 모두 고려하는 가격 책정 함수입니다.** 그리고 우리는 가격을 계산할 필요조차 없습니다!

> 다음은 거래 함수에서 위 공식을 유도하는 방법입니다:
> $$(x + r\Delta x)(y - \Delta y) = xy$$
> $$y - \Delta y = \frac{xy}{x + r\Delta x}$$
> $$-\Delta y = \frac{xy}{x + r\Delta x} - y$$
> $$-\Delta y = \frac{xy - y({x + r\Delta x})}{x + r\Delta x}$$
> $$-\Delta y = \frac{xy - xy - y r \Delta x}{x + r\Delta x}$$
> $$-\Delta y = \frac{- y r \Delta x}{x + r\Delta x}$$
> $$\Delta y = \frac{y r \Delta x}{x + r\Delta x}$$
> 그리고:
> $$(x + r\Delta x)(y - \Delta y) = xy$$
> $$x + r\Delta x = \frac{xy}{y - \Delta y}$$
> $$r\Delta x = \frac{xy}{y - \Delta y} - x$$
> $$r\Delta x = \frac{xy - x(y - \Delta y)}{y - \Delta y}$$
> $$r\Delta x = \frac{xy - xy + x \Delta y}{y - \Delta y}$$
> $$r\Delta x = \frac{x \Delta y}{y - \Delta y}$$
> $$\Delta x = \frac{x \Delta y}{r(y - \Delta y)}$$

## 곡선 (The Curve)

위의 계산은 너무 추상적이고 건조하게 느껴질 수 있습니다. 상수 곱 함수가 어떻게 작동하는지 더 잘 이해하기 위해 시각화해 보겠습니다.

그래프에 그리면 상수 곱 함수는 이차 쌍곡선입니다:



![상수 곱 공식 곡선의 형태](images/the_curve.png)

여기서 축은 풀 준비금입니다. 모든 거래는 현재 준비금 비율에 해당하는 곡선 위의 점에서 시작됩니다. 출력 금액을 계산하려면 $x+\Delta x$의 $x$ 좌표, 즉 토큰 0의 현재 준비금 + 우리가 판매하는 금액을 갖는 곡선 위의 새로운 점을 찾아야 합니다. $y$의 변화량은 우리가 얻게 될 토큰 1의 양입니다.

구체적인 예를 살펴보겠습니다:



![Desmos 차트 예시](images/desmos.png)

1. 보라색 선은 곡선이고, 축은 풀의 준비금입니다 (시작 가격에서 동일하다는 점에 유의하세요).
2. 시작 가격은 1입니다.
3. 토큰 0을 200개 판매합니다. 시작 가격만 사용하면 토큰 1을 200개 얻을 것으로 예상합니다.
4. 그러나 실행 가격은 0.666이므로 토큰 1을 133.333개만 얻습니다!

이 예시는 Uniswap 제작자 중 한 명인 [Dan Robinson](https://twitter.com/danrobinson)이 만든 [Desmos 차트](https://www.desmos.com/calculator/7wbvkts2jf)에서 가져온 것입니다. 작동 방식에 대한 더 나은 직관을 얻으려면 다양한 시나리오를 만들고 그래프에 플롯해 보세요. 다른 준비금을 시도해보고 $\Delta x$가 $x$에 비해 작을 때 출력 금액이 어떻게 변하는지 확인하세요.

> 전설에 따르면 Uniswap은 Desmos에서 발명되었습니다.

왜 이런 곡선을 사용하는지 궁금하실 겁니다. 큰 금액을 거래하면 벌을 받는 것처럼 보일 수도 있습니다. 이것은 사실이며, 이는 바람직한 속성입니다! 수요와 공급의 법칙은 수요가 높을 때 (그리고 공급이 일정할 때) 가격도 높아진다고 말합니다. 그리고 수요가 낮을 때 가격도 낮아집니다. 이것이 시장이 작동하는 방식입니다. 그리고 마법처럼, 상수 곱 함수는 이 메커니즘을 구현합니다! 수요는 구매하려는 금액으로 정의되고, 공급은 풀 준비금입니다. 풀 준비금에 비해 많은 양을 구매하려는 경우, 더 적은 양을 구매하려는 경우보다 가격이 더 높습니다. 이처럼 간단한 공식이 이처럼 강력한 메커니즘을 보장합니다!

Uniswap은 거래 가격을 계산하지 않더라도 곡선에서 가격을 확인할 수 있습니다. 놀랍게도 거래를 할 때 여러 가격이 있습니다:

1. 거래 전에는 *현물 가격*이 있습니다. 이는 거래 방향에 따라 준비금의 비율, $\frac{y}{x}$ 또는 $\frac{x}{y}$와 같습니다. 이 가격은 시작점에서의 *접선의 기울기*이기도 합니다.
2. 거래 후에는 곡선 위의 다른 지점에서 새로운 현물 가격이 있습니다. 그리고 이는 이 새로운 지점에서의 접선의 기울기입니다.
3. 실제 거래 가격은 두 점을 연결하는 선의 기울기입니다!

**이것이 Uniswap의 모든 수학입니다! 휴!**

음, 이것은 Uniswap V2의 수학이고, 우리는 Uniswap V3를 공부하고 있습니다. 따라서 다음 파트에서는 Uniswap V3의 수학이 어떻게 다른지 살펴보겠습니다.
## Manager Contract

í’€ ì»¨íŠ¸ë™íŠ¸ë¥¼ ë°°í¬í•˜ê¸° ì „ì—, í•œ ê°€ì§€ ë¬¸ì œë¥¼ í•´ê²°í•´ì•¼ í•©ë‹ˆë‹¤. ê¸°ì–µí•˜ì‹œê² ì§€ë§Œ, Uniswap V3 ì»¨íŠ¸ë™íŠ¸ëŠ” ë‘ ê°€ì§€ ë²”ì£¼ë¡œ ë‚˜ë‰©ë‹ˆë‹¤:
1. í•µì‹¬ ê¸°ëŠ¥ë“¤ì„ êµ¬í˜„í•˜ê³  ì‚¬ìš©ì ì¹œí™”ì ì¸ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì œê³µí•˜ì§€ ì•ŠëŠ” **ì½”ì–´ ì»¨íŠ¸ë™íŠ¸**.
2. ì½”ì–´ ì»¨íŠ¸ë™íŠ¸ë¥¼ ìœ„í•œ ì‚¬ìš©ì ì¹œí™”ì ì¸ ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ëŠ” **ì£¼ë³€ë¶€ ì»¨íŠ¸ë™íŠ¸**.

í’€ ì»¨íŠ¸ë™íŠ¸ëŠ” ì½”ì–´ ì»¨íŠ¸ë™íŠ¸ì´ë©°, ì‚¬ìš©ì ì¹œí™”ì ì´ê±°ë‚˜ ìœ ì—°í•˜ë„ë¡ ì„¤ê³„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í’€ ì»¨íŠ¸ë™íŠ¸ëŠ” í˜¸ì¶œìê°€ ëª¨ë“  ê³„ì‚° (ê°€ê²©, ìˆ˜ëŸ‰)ì„ ìˆ˜í–‰í•˜ê³  ì ì ˆí•œ í˜¸ì¶œ ë§¤ê°œë³€ìˆ˜ë¥¼ ì œê³µí•  ê²ƒì„ ê¸°ëŒ€í•©ë‹ˆë‹¤. ë˜í•œ í˜¸ì¶œìë¡œë¶€í„° í† í°ì„ ì „ì†¡í•˜ê¸° ìœ„í•´ ERC20ì˜ `transferFrom`ì„ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ëŒ€ì‹ , ë‘ ê°€ì§€ ì½œë°±ì„ ì‚¬ìš©í•©ë‹ˆë‹¤:
1. ìœ ë™ì„±ì„ ë¯¼íŒ…í•  ë•Œ í˜¸ì¶œë˜ëŠ” `uniswapV3MintCallback`;
2. í† í°ì„ ìŠ¤ì™‘í•  ë•Œ í˜¸ì¶œë˜ëŠ” `uniswapV3SwapCallback`.

ìš°ë¦¬ì˜ í…ŒìŠ¤íŠ¸ì—ì„œëŠ” ì´ëŸ¬í•œ ì½œë°±ë“¤ì„ í…ŒìŠ¤íŠ¸ ì»¨íŠ¸ë™íŠ¸ ë‚´ì—ì„œ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤. ì½œë°±ë“¤ì„ êµ¬í˜„í•  ìˆ˜ ìˆëŠ” ê²ƒì€ ì»¨íŠ¸ë™íŠ¸ë¿ì´ë¯€ë¡œ, í’€ ì»¨íŠ¸ë™íŠ¸ëŠ” ì¼ë°˜ ì‚¬ìš©ì (ì»¨íŠ¸ë™íŠ¸ ì£¼ì†Œê°€ ì•„ë‹Œ ì£¼ì†Œ)ì— ì˜í•´ í˜¸ì¶œë  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì´ê²ƒì€ ê´œì°®ì•˜ìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ë” ì´ìƒì€ ì•„ë‹™ë‹ˆë‹¤ ğŸ™‚.

ì´ ì±…ì˜ ë‹¤ìŒ ë‹¨ê³„ëŠ” í’€ ì»¨íŠ¸ë™íŠ¸ë¥¼ ë¡œì»¬ ë¸”ë¡ì²´ì¸ì— ë°°í¬í•˜ê³  í”„ë¡ íŠ¸ì—”ë“œ ì•±ì—ì„œ ìƒí˜¸ì‘ìš©í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ë”°ë¼ì„œ, ì»¨íŠ¸ë™íŠ¸ ì£¼ì†Œê°€ ì•„ë‹Œ ì£¼ì†Œë“¤ì´ í’€ê³¼ ìƒí˜¸ì‘ìš©í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ì»¨íŠ¸ë™íŠ¸ë¥¼ êµ¬ì¶•í•´ì•¼ í•©ë‹ˆë‹¤. ì§€ê¸ˆ ë°”ë¡œ ì‹œì‘í•´ ë´…ì‹œë‹¤!

## ì›Œí¬í”Œë¡œìš°

ë§¤ë‹ˆì € ì»¨íŠ¸ë™íŠ¸ì˜ ì‘ë™ ë°©ì‹ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:
1. ìœ ë™ì„±ì„ ë¯¼íŒ…í•˜ê¸° ìœ„í•´, ë§¤ë‹ˆì € ì»¨íŠ¸ë™íŠ¸ê°€ í† í°ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ìŠ¹ì¸í•©ë‹ˆë‹¤.
2. ê·¸ ë‹¤ìŒ ë§¤ë‹ˆì € ì»¨íŠ¸ë™íŠ¸ì˜ `mint` í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê³ , ë¯¼íŒ… ë§¤ê°œë³€ìˆ˜ì™€ ìœ ë™ì„±ì„ ì œê³µí•˜ë ¤ëŠ” í’€ì˜ ì£¼ì†Œë¥¼ ì „ë‹¬í•©ë‹ˆë‹¤.
3. ë§¤ë‹ˆì € ì»¨íŠ¸ë™íŠ¸ëŠ” í’€ì˜ `mint` í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê³  `uniswapV3MintCallback`ì„ êµ¬í˜„í•©ë‹ˆë‹¤. ë§¤ë‹ˆì € ì»¨íŠ¸ë™íŠ¸ëŠ” ìš°ë¦¬ì˜ í† í°ì„ í’€ ì»¨íŠ¸ë™íŠ¸ë¡œ ë³´ë‚¼ ê¶Œí•œì„ ê°€ì§€ê²Œ ë©ë‹ˆë‹¤.
4. í† í°ì„ ìŠ¤ì™‘í•˜ê¸° ìœ„í•´, ë§ˆì°¬ê°€ì§€ë¡œ ë§¤ë‹ˆì € ì»¨íŠ¸ë™íŠ¸ê°€ í† í°ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ìŠ¹ì¸í•©ë‹ˆë‹¤.
5. ê·¸ ë‹¤ìŒ ë§¤ë‹ˆì € ì»¨íŠ¸ë™íŠ¸ì˜ `swap` í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê³ , ë¯¼íŒ…ê³¼ ìœ ì‚¬í•˜ê²Œ í’€ì—ê²Œ í˜¸ì¶œì„ ì „ë‹¬í•©ë‹ˆë‹¤.
ë§¤ë‹ˆì € ì»¨íŠ¸ë™íŠ¸ëŠ” ìš°ë¦¬ì˜ í† í°ì„ í’€ ì»¨íŠ¸ë™íŠ¸ë¡œ ë³´ë‚´ê³ , í’€ ì»¨íŠ¸ë™íŠ¸ëŠ” í† í°ì„ ìŠ¤ì™‘í•œ í›„ ê²°ê³¼ ìˆ˜ëŸ‰ì„ ìš°ë¦¬ì—ê²Œ ë³´ëƒ…ë‹ˆë‹¤.

ë”°ë¼ì„œ, ë§¤ë‹ˆì € ì»¨íŠ¸ë™íŠ¸ëŠ” ì‚¬ìš©ìì™€ í’€ ì‚¬ì´ì˜ ì¤‘ê°œì ì—­í• ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

## ì½œë°±ì— ë°ì´í„° ì „ë‹¬í•˜ê¸°

ë§¤ë‹ˆì € ì»¨íŠ¸ë™íŠ¸ë¥¼ êµ¬í˜„í•˜ê¸° ì „ì—, í’€ ì»¨íŠ¸ë™íŠ¸ë¥¼ ì—…ê·¸ë ˆì´ë“œí•´ì•¼ í•©ë‹ˆë‹¤.

ë§¤ë‹ˆì € ì»¨íŠ¸ë™íŠ¸ëŠ” ëª¨ë“  í’€ê³¼ ì‘ë™í•˜ë©°, ëª¨ë“  ì£¼ì†Œê°€ ë§¤ë‹ˆì € ì»¨íŠ¸ë™íŠ¸ë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆë„ë¡ í•  ê²ƒì…ë‹ˆë‹¤. ì´ë¥¼ ë‹¬ì„±í•˜ê¸° ìœ„í•´, ì½œë°±ì„ ì—…ê·¸ë ˆì´ë“œí•´ì•¼ í•©ë‹ˆë‹¤: ì„œë¡œ ë‹¤ë¥¸ í’€ ì£¼ì†Œì™€ ì‚¬ìš©ì ì£¼ì†Œë¥¼ ì½œë°±ì— ì „ë‹¬í•˜ê³  ì‹¶ìŠµë‹ˆë‹¤. í˜„ì¬ `uniswapV3MintCallback` êµ¬í˜„ (í…ŒìŠ¤íŠ¸ ì»¨íŠ¸ë™íŠ¸ ë‚´)ì„ ì‚´í´ë´…ì‹œë‹¤:
```solidity
function uniswapV3MintCallback(uint256 amount0, uint256 amount1) public {
    if (transferInMintCallback) {
        token0.transfer(msg.sender, amount0);
        token1.transfer(msg.sender, amount1);
    }
}
```

ì—¬ê¸°ì„œ í•µì‹¬ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:
1. í•¨ìˆ˜ëŠ” í…ŒìŠ¤íŠ¸ ì»¨íŠ¸ë™íŠ¸ì— ì†í•œ í† í°ì„ ì „ì†¡í•©ë‹ˆë‹¤. `transferFrom`ì„ ì‚¬ìš©í•˜ì—¬ í˜¸ì¶œìë¡œë¶€í„° í† í°ì„ ì „ì†¡í•˜ë„ë¡ ë³€ê²½í•˜ê³  ì‹¶ìŠµë‹ˆë‹¤.
2. í•¨ìˆ˜ëŠ” `token0`ê³¼ `token1`ì„ ì•Œê³  ìˆì§€ë§Œ, ì´ëŠ” ëª¨ë“  í’€ë§ˆë‹¤ ë‹¤ë¥¼ ê²ƒì…ë‹ˆë‹¤.

ì•„ì´ë””ì–´: ì‚¬ìš©ì ë° í’€ ì£¼ì†Œë¥¼ ì „ë‹¬í•  ìˆ˜ ìˆë„ë¡ ì½œë°±ì˜ ì¸ìˆ˜ë¥¼ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤.

ì´ì œ ìŠ¤ì™‘ ì½œë°±ì„ ì‚´í´ë´…ì‹œë‹¤:
```solidity
function uniswapV3SwapCallback(int256 amount0, int256 amount1) public {
    if (amount0 > 0 && transferInSwapCallback) {
        token0.transfer(msg.sender, uint256(amount0));
    }

    if (amount1 > 0 && transferInSwapCallback) {
        token1.transfer(msg.sender, uint256(amount1));
    }
}
```

ë™ì¼í•˜ê²Œ, í…ŒìŠ¤íŠ¸ ì»¨íŠ¸ë™íŠ¸ë¡œë¶€í„° í† í°ì„ ì „ì†¡í•˜ê³  `token0`ê³¼ `token1`ì„ ì•Œê³  ìˆìŠµë‹ˆë‹¤.

ì¶”ê°€ ë°ì´í„°ë¥¼ ì½œë°±ì— ì „ë‹¬í•˜ë ¤ë©´, ë¨¼ì € `mint`ì™€ `swap`ì— ë°ì´í„°ë¥¼ ì „ë‹¬í•´ì•¼ í•©ë‹ˆë‹¤ (ì½œë°±ì€ ì´ í•¨ìˆ˜ë“¤ë¡œë¶€í„° í˜¸ì¶œë˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤). ê·¸ëŸ¬ë‚˜ ì´ ì¶”ê°€ ë°ì´í„°ëŠ” í•¨ìˆ˜ ë‚´ì—ì„œ ì‚¬ìš©ë˜ì§€ ì•Šê³  í•¨ìˆ˜ì˜ ì¸ìˆ˜ë¥¼ ë³µì¡í•˜ê²Œ ë§Œë“¤ì§€ ì•Šê¸° ìœ„í•´, [abi.encode()](https://docs.soliditylang.org/en/latest/units-and-global-variables.html?highlight=abi.encode#abi-encoding-and-decoding-functions)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¶”ê°€ ë°ì´í„°ë¥¼ ì¸ì½”ë”©í•  ê²ƒì…ë‹ˆë‹¤.

ì¶”ê°€ ë°ì´í„°ë¥¼ êµ¬ì¡°ì²´ë¡œ ì •ì˜í•´ ë´…ì‹œë‹¤:
```solidity
// src/UniswapV3Pool.sol
...
struct CallbackData {
    address token0;
    address token1;
    address payer;
}
...
```

ê·¸ë¦¬ê³  ì¸ì½”ë”©ëœ ë°ì´í„°ë¥¼ ì½œë°±ì— ì „ë‹¬í•©ë‹ˆë‹¤:
```solidity
function mint(
    address owner,
    int24 lowerTick,
    int24 upperTick,
    uint128 amount,
    bytes calldata data // <--- ìƒˆë¡œìš´ ë¼ì¸
) external returns (uint256 amount0, uint256 amount1) {
    ...
    IUniswapV3MintCallback(msg.sender).uniswapV3MintCallback(
        amount0,
        amount1,
        data // <--- ìƒˆë¡œìš´ ë¼ì¸
    );
    ...
}

function swap(address recipient, bytes calldata data) // <--- `data` ì¶”ê°€ë¨
    public
    returns (int256 amount0, int256 amount1)
{
    ...
    IUniswapV3SwapCallback(msg.sender).uniswapV3SwapCallback(
        amount0,
        amount1,
        data // <--- ìƒˆë¡œìš´ ë¼ì¸
    );
    ...
}
```

ì´ì œ í…ŒìŠ¤íŠ¸ ì»¨íŠ¸ë™íŠ¸ì˜ ì½œë°±ì—ì„œ ì¶”ê°€ ë°ì´í„°ë¥¼ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```solidity
function uniswapV3MintCallback(
    uint256 amount0,
    uint256 amount1,
    bytes calldata data
) public {
    if (transferInMintCallback) {
        UniswapV3Pool.CallbackData memory extra = abi.decode(
            data,
            (UniswapV3Pool.CallbackData)
        );

        IERC20(extra.token0).transferFrom(extra.payer, msg.sender, amount0);
        IERC20(extra.token1).transferFrom(extra.payer, msg.sender, amount1);
    }
}
```

ë‚˜ë¨¸ì§€ ì½”ë“œë¥¼ ìŠ¤ìŠ¤ë¡œ ì—…ë°ì´íŠ¸í•´ ë³´ì„¸ìš”. ë„ˆë¬´ ì–´ë µë‹¤ë©´, [ì´ ì»¤ë°‹](https://github.com/Jeiwan/uniswapv3-code/commit/cda23134fd12a190aaeebe718786545621e16c0e)ì„ ì°¸ê³ í•˜ì…”ë„ ì¢‹ìŠµë‹ˆë‹¤.

## ë§¤ë‹ˆì € ì»¨íŠ¸ë™íŠ¸ êµ¬í˜„í•˜ê¸°

ì½œë°±ì„ êµ¬í˜„í•˜ëŠ” ê²ƒ ì™¸ì—, ë§¤ë‹ˆì € ì»¨íŠ¸ë™íŠ¸ëŠ” ë§ì€ ì¼ì„ í•˜ì§€ëŠ” ì•Šì„ ê²ƒì…ë‹ˆë‹¤: ë‹¨ìˆœíˆ í’€ ì»¨íŠ¸ë™íŠ¸ë¡œ í˜¸ì¶œì„ ë¦¬ë””ë ‰ì…˜í•  ê²ƒì…ë‹ˆë‹¤. ì´ê²ƒì€ í˜„ì¬ ë§¤ìš° ìµœì†Œí•œì˜ ì»¨íŠ¸ë™íŠ¸ì…ë‹ˆë‹¤:
```solidity
pragma solidity ^0.8.14;

import "../src/UniswapV3Pool.sol";
import "../src/interfaces/IERC20.sol";

contract UniswapV3Manager {
    function mint(
        address poolAddress_,
        int24 lowerTick,
        int24 upperTick,
        uint128 liquidity,
        bytes calldata data
    ) public {
        UniswapV3Pool(poolAddress_).mint(
            msg.sender,
            lowerTick,
            upperTick,
            liquidity,
            data
        );
    }

    function swap(address poolAddress_, bytes calldata data) public {
        UniswapV3Pool(poolAddress_).swap(msg.sender, data);
    }

    function uniswapV3MintCallback(...) {...}
    function uniswapV3SwapCallback(...) {...}
}
```

ì½œë°±ì€ í…ŒìŠ¤íŠ¸ ì»¨íŠ¸ë™íŠ¸ì˜ ì½œë°±ê³¼ ë™ì¼í•˜ì§€ë§Œ, ë§¤ë‹ˆì € ì»¨íŠ¸ë™íŠ¸ëŠ” í•­ìƒ í† í°ì„ ì „ì†¡í•˜ë¯€ë¡œ `transferInMintCallback` ë° `transferInSwapCallback` í”Œë˜ê·¸ê°€ ì—†ë‹¤ëŠ” ì ì´ ë‹¤ë¦…ë‹ˆë‹¤.

ì, ì´ì œ í’€ ì»¨íŠ¸ë™íŠ¸ë¥¼ ë°°í¬í•˜ê³  í”„ë¡ íŠ¸ì—”ë“œ ì•±ê³¼ í†µí•©í•  ì¤€ë¹„ê°€ ì™„ì „íˆ ë˜ì—ˆìŠµë‹ˆë‹¤!
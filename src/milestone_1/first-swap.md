## ì²« ë²ˆì§¸ ìŠ¤ì™‘

ì´ì œ ìœ ë™ì„±ì´ í™•ë³´ë˜ì—ˆìœ¼ë‹ˆ, ì²« ë²ˆì§¸ ìŠ¤ì™‘ì„ ìˆ˜í–‰í•´ ë³´ê² ìŠµë‹ˆë‹¤!

### ìŠ¤ì™‘ ì–‘ ê³„ì‚°í•˜ê¸°

ê°€ì¥ ì²« ë²ˆì§¸ ë‹¨ê³„ëŠ” ë‹¹ì—°íˆ ìŠ¤ì™‘ ì–‘ì„ ê³„ì‚°í•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë‚´ëŠ” ê²ƒì…ë‹ˆë‹¤. ê·¸ë¦¬ê³  ë‹¤ì‹œ í•œë²ˆ, ìš°ë¦¬ê°€ ETHë¡œ ê±°ë˜í•  USDCì˜ ì–‘ì„ ì„ì˜ë¡œ ì •í•˜ê³  í•˜ë“œ ì½”ë”©í•´ ë³´ê² ìŠµë‹ˆë‹¤. 42 USDCë¡œ í•©ì‹œë‹¤! ìš°ë¦¬ëŠ” 42 USDCë¡œ ETHë¥¼ êµ¬ë§¤í•  ê²ƒì…ë‹ˆë‹¤.

íŒë§¤í•  í† í°ì˜ ì–‘ì„ ê²°ì •í•œ í›„ì—ëŠ”, ê·¸ ëŒ€ê°€ë¡œ ì–¼ë§ˆë‚˜ ë§ì€ í† í°ì„ ë°›ê²Œ ë ì§€ ê³„ì‚°í•´ì•¼ í•©ë‹ˆë‹¤. Uniswap V2ì—ì„œëŠ” í˜„ì¬ í’€ì˜ ì¤€ë¹„ê¸ˆì„ ì‚¬ìš©í–ˆê² ì§€ë§Œ, Uniswap V3ì—ì„œëŠ” $L$ê³¼ $\sqrt{P}$ë¥¼ ì‚¬ìš©í•˜ë©°, ê°€ê²© ë²”ìœ„ ë‚´ì—ì„œ ìŠ¤ì™‘í•  ë•Œ $\sqrt{P}$ë§Œ ë³€ê²½ë˜ê³  $L$ì€ ë³€í•˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ì‚¬ì‹¤ì„ ì•Œê³  ìˆìŠµë‹ˆë‹¤ (Uniswap V3ëŠ” ìŠ¤ì™‘ì´ í•˜ë‚˜ì˜ ê°€ê²© ë²”ìœ„ ë‚´ì—ì„œë§Œ ìˆ˜í–‰ë  ë•Œ V2ì™€ ì •í™•íˆ ë™ì¼í•˜ê²Œ ì‘ë™í•©ë‹ˆë‹¤). ë˜í•œ ë‹¤ìŒì„ ì•Œê³  ìˆìŠµë‹ˆë‹¤:

$$L = \frac{\Delta y}{\Delta \sqrt{P}}$$

ê·¸ë¦¬ê³ ... ìš°ë¦¬ëŠ” $\Delta y$ë¥¼ ì•Œê³  ìˆìŠµë‹ˆë‹¤! ì´ê²ƒì´ ìš°ë¦¬ê°€ ê±°ë˜í•  42 USDCì…ë‹ˆë‹¤! ë”°ë¼ì„œ, $L$ì´ ì£¼ì–´ì¡Œì„ ë•Œ 42 USDC íŒë§¤ê°€ í˜„ì¬ $\sqrt{P}$ì— ì–´ë–¤ ì˜í–¥ì„ ë¯¸ì¹ ì§€ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

$$\Delta \sqrt{P} = \frac{\Delta y}{L}$$

Uniswap V3ì—ì„œëŠ” **ìš°ë¦¬ê°€ ê±°ë˜ë¥¼ í†µí•´ ë„ë‹¬í•˜ê³ ì í•˜ëŠ” ê°€ê²©**ì„ ì„ íƒí•©ë‹ˆë‹¤ (ìŠ¤ì™‘ì€ í˜„ì¬ ê°€ê²©ì„ ë³€ê²½, ì¦‰ í˜„ì¬ ê°€ê²©ì„ ê³¡ì„ ì„ ë”°ë¼ ì´ë™ì‹œí‚¨ë‹¤ëŠ” ê²ƒì„ ìƒê¸°í•˜ì‹­ì‹œì˜¤). ëª©í‘œ ê°€ê²©ì„ ì•Œë©´, ì»¨íŠ¸ë™íŠ¸ëŠ” ìš°ë¦¬ë¡œë¶€í„° ê°€ì ¸ì™€ì•¼ í•  ì…ë ¥ í† í°ì˜ ì–‘ê³¼ ê·¸ì— ìƒì‘í•˜ëŠ” ì¶œë ¥ í† í°ì˜ ì–‘ì„ ê³„ì‚°í•©ë‹ˆë‹¤.

ìœ„ì˜ ê³µì‹ì— ìˆ«ìë¥¼ ëŒ€ì…í•´ ë³´ê² ìŠµë‹ˆë‹¤:

$$\Delta \sqrt{P} = \frac{42 \enspace USDC}{1517882343751509868544} = 2192253463713690532467206957$$

ì´ ê°’ì„ í˜„ì¬ $\sqrt{P}$ì— ë”í•˜ë©´ ëª©í‘œ ê°€ê²©ì„ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

$$\sqrt{P_{target}} = \sqrt{P_{current}} + \Delta \sqrt{P}$$

$$\sqrt{P_{target}} = 5604469350942327889444743441197}$$

> Pythonìœ¼ë¡œ ëª©í‘œ ê°€ê²©ì„ ê³„ì‚°í•˜ë ¤ë©´:
> ```python
> amount_in = 42 * eth
> price_diff = (amount_in * q96) // liq
> price_next = sqrtp_cur + price_diff
> print("New price:", (price_next / q96) ** 2)
> print("New sqrtP:", price_next)
> print("New tick:", price_to_tick((price_next / q96) ** 2))
> # New price: 5003.913912782393
> # New sqrtP: 5604469350942327889444743441197
> # New tick: 85184
> ```

ëª©í‘œ ê°€ê²©ì„ ì°¾ì€ í›„ì—ëŠ” ì´ì „ ì¥ì—ì„œ ì‚¬ìš©í•œ ì–‘ ê³„ì‚° í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ í† í° ì–‘ì„ ê³„ì‚°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

$$ x = \frac{L(\sqrt{p_b}-\sqrt{p_a})}{\sqrt{p_b}\sqrt{p_a}}$$
$$ y = L(\sqrt{p_b}-\sqrt{p_a}) $$

> Pythonì—ì„œ:
> ```python
> amount_in = calc_amount1(liq, price_next, sqrtp_cur)
> amount_out = calc_amount0(liq, price_next, sqrtp_cur)
>
> print("USDC in:", amount_in / eth)
> print("ETH out:", amount_out / eth)
> # USDC in: 42.0
> # ETH out: 0.008396714242162444
> ```

ì–‘ì„ ê²€ì¦í•˜ê¸° ìœ„í•´, ë‹¤ë¥¸ ê³µì‹ì„ ë– ì˜¬ë ¤ ë´…ì‹œë‹¤:

$$\Delta x = \Delta \frac{1}{\sqrt{P}} L$$

ì´ ê³µì‹ì„ ì‚¬ìš©í•˜ì—¬, ê°€ê²© ë³€í™” $\Delta\frac{1}{\sqrt{P}}$ì™€ ìœ ë™ì„± $L$ì„ ì•Œë©´ ìš°ë¦¬ê°€ êµ¬ë§¤í•˜ëŠ” ETHì˜ ì–‘ $\Delta x$ë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì£¼ì˜í•˜ì„¸ìš”: $\Delta \frac{1}{\sqrt{P}}$ëŠ” $\frac{1}{\Delta \sqrt{P}}$ê°€ ì•„ë‹™ë‹ˆë‹¤! ì „ìëŠ” ETH ê°€ê²©ì˜ ë³€í™”ì´ê³ , ë‹¤ìŒ í‘œí˜„ì‹ì„ ì‚¬ìš©í•˜ì—¬ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

$$\Delta \frac{1}{\sqrt{P}} = \frac{1}{\sqrt{P_{target}}} - \frac{1}{\sqrt{P_{current}}}$$

ë‹¤í–‰íˆë„, ìš°ë¦¬ëŠ” ì´ë¯¸ ëª¨ë“  ê°’ì„ ì•Œê³  ìˆìœ¼ë¯€ë¡œ, ë°”ë¡œ ëŒ€ì…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (í™”ë©´ì— ë‹¤ ë“¤ì–´ê°€ì§€ ì•Šì„ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤!):

$$\Delta \frac{1}{\sqrt{P}} = \frac{1}{5604469350942327889444743441197} - \frac{1}{5602277097478614198912276234240}$$

$$= -6.982190286589445\text{e-}35 * 2^{96} $$
$$= -0.00000553186106731426$$

ì´ì œ $\Delta x$ë¥¼ êµ¬í•´ë´…ì‹œë‹¤:

$$\Delta x = -0.00000553186106731426 * 1517882343751509868544 = -8396714242162698 $$

ì´ëŠ” 0.008396714242162698 ETHì´ë©°, ìœ„ì—ì„œ êµ¬í•œ ê°’ê³¼ ë§¤ìš° ìœ ì‚¬í•©ë‹ˆë‹¤! ì´ ì–‘ì€ í’€ì—ì„œ ì œê±°ë˜ë¯€ë¡œ ìŒìˆ˜ë¼ëŠ” ì ì— ìœ ì˜í•˜ì‹­ì‹œì˜¤.

### ìŠ¤ì™‘ êµ¬í˜„í•˜ê¸°

ìŠ¤ì™‘ì€ `swap` í•¨ìˆ˜ì—ì„œ êµ¬í˜„ë©ë‹ˆë‹¤:
```solidity
function swap(address recipient)
    public
    returns (int256 amount0, int256 amount1)
{
    ...
```
í˜„ì¬ë¡œì„œëŠ” í† í° ìˆ˜ì‹ ìì¸ ìˆ˜ë ¹ì¸ë§Œ ì¸ìˆ˜ë¡œ ë°›ìŠµë‹ˆë‹¤.

ë¨¼ì €, ëª©í‘œ ê°€ê²©ê³¼ í‹±ì„ ì°¾ê³ , í† í° ì–‘ì„ ê³„ì‚°í•´ì•¼ í•©ë‹ˆë‹¤. ë‹¤ì‹œ í•œë²ˆ, ê°„ë‹¨í•˜ê²Œ ìœ ì§€í•˜ê¸° ìœ„í•´ ì´ì „ì— ê³„ì‚°í•œ ê°’ì„ í•˜ë“œ ì½”ë”©í•˜ê² ìŠµë‹ˆë‹¤:
```solidity
...
int24 nextTick = 85184;
uint160 nextPrice = 5604469350942327889444743441197;

amount0 = -0.008396714242162444 ether;
amount1 = 42 ether;
...
```

ë‹¤ìŒìœ¼ë¡œ, ê±°ë˜ëŠ” í˜„ì¬ ê°€ê²©ì— ì˜í–¥ì„ ë¯¸ì¹˜ë¯€ë¡œ í˜„ì¬ í‹±ê³¼ `sqrtP`ë¥¼ ì—…ë°ì´íŠ¸í•´ì•¼ í•©ë‹ˆë‹¤:
```solidity
...
(slot0.tick, slot0.sqrtPriceX96) = (nextTick, nextPrice);
...
```

ë‹¤ìŒìœ¼ë¡œ, ì»¨íŠ¸ë™íŠ¸ëŠ” ìˆ˜ë ¹ì¸ì—ê²Œ í† í°ì„ ë³´ë‚´ê³ , í˜¸ì¶œìê°€ ì…ë ¥ ê¸ˆì•¡ì„ ì»¨íŠ¸ë™íŠ¸ë¡œ ì „ì†¡í•˜ë„ë¡ í•©ë‹ˆë‹¤:
```solidity
...
IERC20(token0).transfer(recipient, uint256(-amount0));

uint256 balance1Before = balance1();
IUniswapV3SwapCallback(msg.sender).uniswapV3SwapCallback(
    amount0,
    amount1
);
if (balance1Before + uint256(amount1) < balance1())
    revert InsufficientInputAmount();
...
```

ë‹¤ì‹œ í•œë²ˆ, ì½œë°±ì„ ì‚¬ìš©í•˜ì—¬ ì œì–´ë¥¼ í˜¸ì¶œìì—ê²Œ ì „ë‹¬í•˜ê³  í† í°ì„ ì „ì†¡í•˜ë„ë¡ í•©ë‹ˆë‹¤. ê·¸ í›„, í’€ì˜ ì”ì•¡ì´ ì˜¬ë°”ë¥¸ì§€, ì…ë ¥ ê¸ˆì•¡ì´ í¬í•¨ë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.

ë§ˆì§€ë§‰ìœ¼ë¡œ, ì»¨íŠ¸ë™íŠ¸ëŠ” ìŠ¤ì™‘ì„ ê²€ìƒ‰ ê°€ëŠ¥í•˜ê²Œ ë§Œë“¤ê¸° ìœ„í•´ `Swap` ì´ë²¤íŠ¸ë¥¼ ë°œìƒì‹œí‚µë‹ˆë‹¤. ì´ë²¤íŠ¸ì—ëŠ” ìŠ¤ì™‘ì— ëŒ€í•œ ëª¨ë“  ì •ë³´ê°€ í¬í•¨ë©ë‹ˆë‹¤:
```solidity
...
emit Swap(
    msg.sender,
    recipient,
    amount0,
    amount1,
    slot0.sqrtPriceX96,
    liquidity,
    slot0.tick
);
```

ì´ê²ƒìœ¼ë¡œ ëì…ë‹ˆë‹¤! í•¨ìˆ˜ëŠ” ì§€ì •ëœ ìˆ˜ë ¹ì¸ ì£¼ì†Œë¡œ ì¼ì •ëŸ‰ì˜ í† í°ì„ ë³´ë‚´ê³ , ê·¸ ëŒ€ê°€ë¡œ ë‹¤ë¥¸ í† í°ì„ íŠ¹ì • ìˆ˜ëŸ‰ë§Œí¼ ë°›ê¸°ë¥¼ ê¸°ëŒ€í•©ë‹ˆë‹¤. ì´ ì±… ì „ì²´ë¥¼ í†µí•´, ì´ í•¨ìˆ˜ëŠ” í›¨ì”¬ ë” ë³µì¡í•´ì§ˆ ê²ƒì…ë‹ˆë‹¤.

### ìŠ¤ì™‘ í…ŒìŠ¤íŠ¸í•˜ê¸°

ì´ì œ ìŠ¤ì™‘ í•¨ìˆ˜ë¥¼ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë™ì¼í•œ í…ŒìŠ¤íŠ¸ íŒŒì¼ì—ì„œ `testSwapBuyEth` í•¨ìˆ˜ë¥¼ ë§Œë“¤ê³  í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. ì´ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ëŠ” `testMintSuccess`ì™€ ë™ì¼í•œ ë§¤ê°œë³€ìˆ˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤:
```solidity
function testSwapBuyEth() public {
    TestCaseParams memory params = TestCaseParams({
        wethBalance: 1 ether,
        usdcBalance: 5000 ether,
        currentTick: 85176,
        lowerTick: 84222,
        upperTick: 86129,
        liquidity: 1517882343751509868544,
        currentSqrtP: 5602277097478614198912276234240,
        shouldTransferInCallback: true,
        mintLiqudity: true
    });
    (uint256 poolBalance0, uint256 poolBalance1) = setupTestCase(params);

    ...
```

ê·¸ëŸ¬ë‚˜ ë‹¤ìŒ ë‹¨ê³„ëŠ” ë‹¤ë¥¼ ê²ƒì…ë‹ˆë‹¤.

> ìœ ë™ì„±ì´ í’€ì— ì˜¬ë°”ë¥´ê²Œ ì¶”ê°€ë˜ì—ˆëŠ”ì§€ í…ŒìŠ¤íŠ¸í•˜ëŠ” ê²ƒì€ ë‹¤ë¥¸ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ì—ì„œ ì´ë¯¸ í…ŒìŠ¤íŠ¸í–ˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ìƒëµí•©ë‹ˆë‹¤.

í…ŒìŠ¤íŠ¸ ìŠ¤ì™‘ì„ ìˆ˜í–‰í•˜ë ¤ë©´ 42 USDCê°€ í•„ìš”í•©ë‹ˆë‹¤:
```solidity
token1.mint(address(this), 42 ether);
```

ìŠ¤ì™‘ì„ ìˆ˜í–‰í•˜ê¸° ì „ì—, í’€ ì»¨íŠ¸ë™íŠ¸ê°€ ìš”ì²­í•  ë•Œ í† í°ì„ ì»¨íŠ¸ë™íŠ¸ë¡œ ì „ì†¡í•  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤:
```solidity
function uniswapV3SwapCallback(int256 amount0, int256 amount1) public {
    if (amount0 > 0) {
        token0.transfer(msg.sender, uint256(amount0));
    }

    if (amount1 > 0) {
        token1.transfer(msg.sender, uint256(amount1));
    }
}
```
ìŠ¤ì™‘ ì¤‘ ì–‘ì€ ì–‘ìˆ˜ (í’€ë¡œ ë³´ë‚´ëŠ” ì–‘) ë° ìŒìˆ˜ (í’€ì—ì„œ ê°€ì ¸ì˜¤ëŠ” ì–‘)ê°€ ë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì½œë°±ì—ì„œ ìš°ë¦¬ëŠ” ì–‘ìˆ˜ ì–‘, ì¦‰ ìš°ë¦¬ê°€ ê±°ë˜í•˜ëŠ” ì–‘ë§Œ ë³´ë‚´ê³  ì‹¶ìŠµë‹ˆë‹¤.

ì´ì œ `swap`ì„ í˜¸ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```solidity
(int256 amount0Delta, int256 amount1Delta) = pool.swap(address(this));
```

í•¨ìˆ˜ëŠ” ìŠ¤ì™‘ì— ì‚¬ìš©ëœ í† í° ì–‘ì„ ë°˜í™˜í•˜ë©°, ì¦‰ì‹œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```solidity
assertEq(amount0Delta, -0.008396714242162444 ether, "invalid ETH out");
assertEq(amount1Delta, 42 ether, "invalid USDC in");
```

ê·¸ëŸ° ë‹¤ìŒ, í† í°ì´ í˜¸ì¶œìë¡œë¶€í„° ì „ì†¡ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤:
```solidity
assertEq(
    token0.balanceOf(address(this)),
    uint256(userBalance0Before - amount0Delta),
    "invalid user ETH balance"
);
assertEq(
    token1.balanceOf(address(this)),
    0,
    "invalid user USDC balance"
);
```

ê·¸ë¦¬ê³  í’€ ì»¨íŠ¸ë™íŠ¸ë¡œ ì „ì†¡ë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤:
```solidity
assertEq(
    token0.balanceOf(address(pool)),
    uint256(int256(poolBalance0) + amount0Delta),
    "invalid pool ETH balance"
);
assertEq(
    token1.balanceOf(address(pool)),
    uint256(int256(poolBalance1) + amount1Delta),
    "invalid pool USDC balance"
);
```

ë§ˆì§€ë§‰ìœ¼ë¡œ, í’€ ìƒíƒœê°€ ì˜¬ë°”ë¥´ê²Œ ì—…ë°ì´íŠ¸ë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤:
```solidity
(uint160 sqrtPriceX96, int24 tick) = pool.slot0();
assertEq(
    sqrtPriceX96,
    5604469350942327889444743441197,
    "invalid current sqrtP"
);
assertEq(tick, 85184, "invalid current tick");
assertEq(
    pool.liquidity(),
    1517882343751509868544,
    "invalid current liquidity"
);
```

ìŠ¤ì™‘ì€ í˜„ì¬ ìœ ë™ì„±ì„ ë³€ê²½í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ìœ ë™ì„±ì´ ë³€ê²½ë˜ëŠ” ì‹œì ì„ ë‹¤ë£¨ëŠ” ì¥ì—ì„œ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

### ìˆ™ì œ

`InsufficientInputAmount` ì—ëŸ¬ë¡œ ì‹¤íŒ¨í•˜ëŠ” í…ŒìŠ¤íŠ¸ë¥¼ ì‘ì„±í•˜ì„¸ìš”. ìˆ¨ê²¨ì§„ ë²„ê·¸ê°€ ìˆë‹¤ëŠ” ê²ƒì„ ëª…ì‹¬í•˜ì„¸ìš” ğŸ™‚